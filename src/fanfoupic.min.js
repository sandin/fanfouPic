(function(b){function m(){if(b.fn.ajaxSubmit.debug){var a="[jquery.form] "+Array.prototype.join.call(arguments,"");if(window.console&&window.console.log)window.console.log(a);else window.opera&&window.opera.postError&&window.opera.postError(a)}}b.fn.ajaxSubmit=function(a){function f(){function x(){var g=k.attr("target"),l=k.attr("action");o.setAttribute("target",v);o.getAttribute("method")!="POST"&&o.setAttribute("method","POST");o.getAttribute("action")!=e.url&&o.setAttribute("action",e.url);e.skipEncodingOverride||
k.attr({encoding:"multipart/form-data",enctype:"multipart/form-data"});if(e.timeout)E=setTimeout(function(){D=true;r(true)},e.timeout);var s=[];try{if(e.extraData)for(var t in e.extraData)s.push(b('<input type="hidden" name="'+t+'" value="'+e.extraData[t]+'" />').appendTo(o)[0]);u.appendTo("body");q.attachEvent?q.attachEvent("onload",r):q.addEventListener("load",r,false);o.submit()}finally{o.setAttribute("action",l);g?o.setAttribute("target",g):k.removeAttr("target");b(s).remove()}}function r(g){if(!(j.aborted||
F))if(g===true&&j)j.abort("timeout");else{g=q.contentWindow?q.contentWindow.document:q.contentDocument?q.contentDocument:q.document;if(!g||g.location.href==e.iframeSrc)if(!D)return;q.detachEvent?q.detachEvent("onload",r):q.removeEventListener("load",r,false);var l=true;try{if(D)throw"timeout";var s=e.dataType=="xml"||g.XMLDocument||b.isXMLDoc(g);m("isXml="+s);if(!s&&window.opera&&(g.body==null||g.body.innerHTML==""))if(--J){m("requeing onLoad callback, DOM not available");setTimeout(r,250);return}j.responseText=
g.body?g.body.innerHTML:g.documentElement?g.documentElement.innerHTML:null;j.responseXML=g.XMLDocument?g.XMLDocument:g;if(s)e.dataType="xml";j.getResponseHeader=function(K){return{"content-type":e.dataType}[K]};var t=/(json|script|text)/.test(e.dataType);if(t||e.textarea){var y=g.getElementsByTagName("textarea")[0];if(y)j.responseText=y.value;else if(t){var G=g.getElementsByTagName("pre")[0],H=g.getElementsByTagName("body")[0];if(G)j.responseText=G.textContent;else if(H)j.responseText=H.innerHTML}}else if(e.dataType==
"xml"&&!j.responseXML&&j.responseText!=null)j.responseXML=L(j.responseText);I=M(j,e.dataType,e)}catch(A){m("error caught:",A);l=false;j.error=A;e.error&&e.error.call(e.context,j,"error",A);w&&b.event.trigger("ajaxError",[j,e,A])}if(j.aborted){m("upload aborted");l=false}if(l){e.success&&e.success.call(e.context,I,"success",j);w&&b.event.trigger("ajaxSuccess",[j,e])}w&&b.event.trigger("ajaxComplete",[j,e]);w&&!--b.active&&b.event.trigger("ajaxStop");e.complete&&e.complete.call(e.context,j,l?"success":
"error");F=true;e.timeout&&clearTimeout(E);setTimeout(function(){u.removeData("form-plugin-onload");u.remove();j.responseXML=null},100)}}var o=k[0];if(b(":input[name=submit],:input[id=submit]",o).length)alert('Error: Form elements must not have name or id of "submit".');else{var e=b.extend(true,{},b.ajaxSettings,a);e.context=e.context||e;var v="jqFormIO"+(new Date).getTime(),u=b('<iframe id="'+v+'" name="'+v+'" src="'+e.iframeSrc+'" />'),q=u[0];u.css({position:"absolute",top:"-1000px",left:"-1000px"});
var j={aborted:0,responseText:null,responseXML:null,status:0,statusText:"n/a",getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(g){g=g==="timeout"?"timeout":"aborted";m("aborting upload... "+g);this.aborted=1;u.attr("src",e.iframeSrc);j.error=g;e.error&&e.error.call(e.context,j,g,g);w&&b.event.trigger("ajaxError",[j,e,g]);e.complete&&e.complete.call(e.context,j,g)}},w=e.global;w&&!b.active++&&b.event.trigger("ajaxStart");w&&b.event.trigger("ajaxSend",
[j,e]);if(e.beforeSend&&e.beforeSend.call(e.context,j,e)===false)e.global&&b.active--;else if(!j.aborted){var D=0,E,z=o.clk;if(z){var B=z.name;if(B&&!z.disabled){e.extraData=e.extraData||{};e.extraData[B]=z.value;if(z.type=="image"){e.extraData[B+".x"]=o.clk_x;e.extraData[B+".y"]=o.clk_y}}}e.forceSync?x():setTimeout(x,10);var I,J=50,F,L=b.parseXML||function(g,l){if(window.ActiveXObject){l=new ActiveXObject("Microsoft.XMLDOM");l.async="false";l.loadXML(g)}else l=(new DOMParser).parseFromString(g,"text/xml");
return l&&l.documentElement&&l.documentElement.nodeName!="parsererror"?l:null},N=b.parseJSON||function(g){return window.eval("("+g+")")},M=function(g,l,s){var t=g.getResponseHeader("content-type")||"",y=l==="xml"||!l&&t.indexOf("xml")>=0;g=y?g.responseXML:g.responseText;y&&g.documentElement.nodeName==="parsererror"&&b.error&&b.error("parsererror");if(s&&s.dataFilter)g=s.dataFilter(g,l);if(typeof g==="string")if(l==="json"||!l&&t.indexOf("json")>=0)g=N(g);else if(l==="script"||!l&&t.indexOf("javascript")>=
0)b.globalEval(g);return g}}}}if(!this.length){m("ajaxSubmit: skipping submit process - no element selected");return this}if(typeof a=="function")a={success:a};var d=this.attr("action");if(d=typeof d==="string"?b.trim(d):"")d=(d.match(/^([^#]+)/)||[])[1];d=d||window.location.href||"";a=b.extend(true,{url:d,success:b.ajaxSettings.success,type:this[0].getAttribute("method")||"GET",iframeSrc:/^https/i.test(window.location.href||"")?"javascript:false":"about:blank"},a);d={};this.trigger("form-pre-serialize",
[this,a,d]);if(d.veto){m("ajaxSubmit: submit vetoed via form-pre-serialize trigger");return this}if(a.beforeSerialize&&a.beforeSerialize(this,a)===false){m("ajaxSubmit: submit aborted via beforeSerialize callback");return this}var c,i,h=this.formToArray(a.semantic);if(a.data){a.extraData=a.data;for(c in a.data)if(a.data[c]instanceof Array)for(var n in a.data[c])h.push({name:c,value:a.data[c][n]});else{i=a.data[c];i=b.isFunction(i)?i():i;h.push({name:c,value:i})}}if(a.beforeSubmit&&a.beforeSubmit(h,
this,a)===false){m("ajaxSubmit: submit aborted via beforeSubmit callback");return this}this.trigger("form-submit-validate",[h,this,a,d]);if(d.veto){m("ajaxSubmit: submit vetoed via form-submit-validate trigger");return this}c=b.param(h);if(a.type.toUpperCase()=="GET"){a.url+=(a.url.indexOf("?")>=0?"&":"?")+c;a.data=null}else a.data=c;var k=this,p=[];a.resetForm&&p.push(function(){k.resetForm()});a.clearForm&&p.push(function(){k.clearForm()});if(!a.dataType&&a.target){var C=a.success||function(){};
p.push(function(x){var r=a.replaceTarget?"replaceWith":"html";b(a.target)[r](x).each(C,arguments)})}else a.success&&p.push(a.success);a.success=function(x,r,o){for(var e=a.context||a,v=0,u=p.length;v<u;v++)p[v].apply(e,[x,r,o||k,k])};c=b("input:file",this).length>0;n=k.attr("enctype")=="multipart/form-data"||k.attr("encoding")=="multipart/form-data";if(a.iframe!==false&&(c||a.iframe||n))a.closeKeepAlive?b.get(a.closeKeepAlive,f):f();else b.ajax(a);this.trigger("form-submit-notify",[this,a]);return this};
b.fn.ajaxForm=function(a){if(this.length===0){var f={s:this.selector,c:this.context};if(!b.isReady&&f.s){m("DOM not ready, queuing ajaxForm");b(function(){b(f.s,f.c).ajaxForm(a)});return this}m("terminating; zero elements found by selector"+(b.isReady?"":" (DOM not ready)"));return this}return this.ajaxFormUnbind().bind("submit.form-plugin",function(d){if(!d.isDefaultPrevented()){d.preventDefault();b(this).ajaxSubmit(a)}}).bind("click.form-plugin",function(d){var c=d.target,i=b(c);if(!i.is(":submit,input:image")){c=
i.closest(":submit");if(c.length==0)return;c=c[0]}var h=this;h.clk=c;if(c.type=="image")if(d.offsetX!=undefined){h.clk_x=d.offsetX;h.clk_y=d.offsetY}else if(typeof b.fn.offset=="function"){i=i.offset();h.clk_x=d.pageX-i.left;h.clk_y=d.pageY-i.top}else{h.clk_x=d.pageX-c.offsetLeft;h.clk_y=d.pageY-c.offsetTop}setTimeout(function(){h.clk=h.clk_x=h.clk_y=null},100)})};b.fn.ajaxFormUnbind=function(){return this.unbind("submit.form-plugin click.form-plugin")};b.fn.formToArray=function(a){var f=[];if(this.length===
0)return f;var d=this[0],c=a?d.getElementsByTagName("*"):d.elements;if(!c)return f;var i,h,n,k,p,C;i=0;for(p=c.length;i<p;i++){h=c[i];if(n=h.name)if(a&&d.clk&&h.type=="image"){if(!h.disabled&&d.clk==h){f.push({name:n,value:b(h).val()});f.push({name:n+".x",value:d.clk_x},{name:n+".y",value:d.clk_y})}}else if((k=b.fieldValue(h,true))&&k.constructor==Array){h=0;for(C=k.length;h<C;h++)f.push({name:n,value:k[h]})}else k!==null&&typeof k!="undefined"&&f.push({name:n,value:k})}if(!a&&d.clk){a=b(d.clk);c=
a[0];if((n=c.name)&&!c.disabled&&c.type=="image"){f.push({name:n,value:a.val()});f.push({name:n+".x",value:d.clk_x},{name:n+".y",value:d.clk_y})}}return f};b.fn.formSerialize=function(a){return b.param(this.formToArray(a))};b.fn.fieldSerialize=function(a){var f=[];this.each(function(){var d=this.name;if(d){var c=b.fieldValue(this,a);if(c&&c.constructor==Array)for(var i=0,h=c.length;i<h;i++)f.push({name:d,value:c[i]});else c!==null&&typeof c!="undefined"&&f.push({name:this.name,value:c})}});return b.param(f)};
b.fn.fieldValue=function(a){for(var f=[],d=0,c=this.length;d<c;d++){var i=b.fieldValue(this[d],a);i===null||typeof i=="undefined"||i.constructor==Array&&!i.length||(i.constructor==Array?b.merge(f,i):f.push(i))}return f};b.fieldValue=function(a,f){var d=a.name,c=a.type,i=a.tagName.toLowerCase();if(f===undefined)f=true;if(f&&(!d||a.disabled||c=="reset"||c=="button"||(c=="checkbox"||c=="radio")&&!a.checked||(c=="submit"||c=="image")&&a.form&&a.form.clk!=a||i=="select"&&a.selectedIndex==-1))return null;
if(i=="select"){var h=a.selectedIndex;if(h<0)return null;d=[];i=a.options;var n=(c=c=="select-one")?h+1:i.length;for(h=c?h:0;h<n;h++){var k=i[h];if(k.selected){var p=k.value;p||(p=k.attributes&&k.attributes.value&&!k.attributes.value.specified?k.text:k.value);if(c)return p;d.push(p)}}return d}return b(a).val()};b.fn.clearForm=function(){return this.each(function(){b("input,select,textarea",this).clearFields()})};b.fn.clearFields=b.fn.clearInputs=function(){return this.each(function(){var a=this.type,
f=this.tagName.toLowerCase();if(a=="text"||a=="password"||f=="textarea")this.value="";else if(a=="checkbox"||a=="radio")this.checked=false;else if(f=="select")this.selectedIndex=-1})};b.fn.resetForm=function(){return this.each(function(){if(typeof this.reset=="function"||typeof this.reset=="object"&&!this.reset.nodeType)this.reset()})};b.fn.enable=function(a){if(a===undefined)a=true;return this.each(function(){this.disabled=!a})};b.fn.selected=function(a){if(a===undefined)a=true;return this.each(function(){var f=
this.type;if(f=="checkbox"||f=="radio")this.checked=a;else if(this.tagName.toLowerCase()=="option"){f=b(this).parent("select");a&&f[0]&&f[0].type=="select-one"&&f.find("option").selected(false);this.selected=a}})}})(jQuery);
(function(b,m){if(typeof m.jQuery!=="undefined"){var a={options:{wrapElem:"#update",tokenElem:'[name="token"]',id:"lds_fanPic",url:"http://localhost/fanfou/upload.php",formJs:"https://github.com/malsup/form/raw/master/jquery.form.js",okFlag:/发送成功/,sysMsgClass:"sysmsg",containerElem:"#container",i18n:{OK:"发送成功",FAIL:"发送失败"}},init:function(){this.replaceForm();this.bindEvent()},replaceForm:function(){var f=this.options,d=b(f.tokenElem).val()||(new Date).valueOf();b(f.wrapElem).html(this.createPicForm(f.id,
f.url,d))},bindEvent:function(){var f=this,d=this.options;typeof m.jQuery.fn.ajaxForm!="undefined"?b("#"+d.id).ajaxForm({dataType:"html",beforeSubmit:function(c,i,h){console.log(c,i,h)},success:function(c){console.log(c);c=d.okFlag.test(c)?d.i18n.OK:d.i18n.FAIL;f.showMsg(c)}}):console.error("need ajaxForm plugin")},showMsg:function(f){var d=this.options,c=b("."+d.sysMsgClass);if(c.length>0)c.text(f);else{b("<div />").addClass(d.sysMsgClass).text(f).appendTo(b(d.containerElem));console.log(b(d.containerElem))}},
createPicForm:function(f,d,c){return'<form id="'+f+'" method="post" action="'+d+'" enctype="multipart/form-data"><p>1.选择照片：<input type="file" name="picture" size="20" /></p><p>2.填写描述：<textarea maxlength="140" name="desc" rows="3" class="i"></textarea></p><p><input type="hidden" name="action" value="photo.upload" /><input type="hidden" name="photo" value="" /><input type="hidden" name="token" value="'+c+'" /><input type="submit" class="formbutton" value="确定" /></p></form>'}};jQuery(m).load(function(){a.init()})}})(jQuery,
window);

